---
title: "Estatística Computacional"
subtitle: "__CÓDIGOS__"
author: "André Leite"
email: "leite@castlab.org"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    katex: true
    toc: false
    highlight: github
---

<!-- Para deixar fundo no rpubs.com branco como deveria ser... -->
<style>
body { background-color: white; }
pre, pre:not([class]) { background-color: white; }
</style>
<!-- Fim de "Para deixar fundo no rpubs.com branco como deveria ser..." -->

> [...] all models are approximations. Essentially, all models are wrong, but some are useful. However, the approximate nature of the model must always be borne in mind [...] 
<div style="text-align: right">
>--- **George Box** (1987, *Empirical Model-Building and Response Surfaces*, p. 424)
</div>


## Pacotes utilizados


```{r setup, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(leaflet)
library(knitr)
library(tidyverse)
library(haven)
library(kableExtra)
library(formattable)
library(htmltools)
#library(webshot) # Desnecessário
#library(gm)
library(kableExtra)
library(ggrepel)
library(lubridate)
library(GGally)
library(mosaicData)
library(paletteer)
library(tidymodels)
library(fastDummies)
```



## Desafio

>>  Teste prático para os candidatos ao processo seletivo de **cientistas**, **analistas** e **engenheiros de dados** para o time de Business Science & Analytics do olist

Fonte: https://github.com/olist/work-at-olist-data

```{r project, results='asis', echo=FALSE, eval=FALSE}

webshot::webshot("https://www.olist.com/", "images/olist.png", cliprect = "viewport", delay = 10)
 
```

<div> 
<img src="images/olist.com.png" width=100%">
</div>





## Cenário

<div class = 'text' style="padding-left:30px">
*O __olist__ é a maior loja de departamentos dos marketplaces. Possui um catálogo com mais de 950 mil produtos, centenas de milhares de pedidos e uma rede de mais de 9 mil lojistas parceiros espalhados por todas as regiões do Brasil. Entendemos que a área de dados e inteligência é uma das principais alavancas de crescimento do negócio, por isso buscamos profissionais apaixonados por dados para integrar a nossa equipe de Business Science e Analytics (BSA).*

*Estamos o tempo todo gerando dados, dados e muito mais dados. Nosso cenário é de big data!*
</div>

## Banco de dados

<div> 
<img src="images/olist_schema.png" width=100%">
</div>

## Plataforma de e-commerce

<div> 
<img src="images/olist_example.png" width=100%">
</div>

## Desafio

<div class = 'dado_full_width'>
- Será que nossos diferentes lojistas associados conseguem manter o preço do mesmo produto sem grandes discrepâncias?
- Existe diferença no valor do frete praticado em regiões/cidades diferentes? Ou podemos aplicar as mesmas regras de subsídio de frete para qualquer localidade?
- Será que nosso catálogo de produtos é abrangente? Ou tem foco em categorias 
- Será que nosso catálogo de produtos é abrangente? Ou tem foco em categorias específicas?
- Será que sempre vendemos os mesmos produtos? Ou existem sazonalidades?
- Será que existe um modelo preditivo para nos preparar para o futuro?
- Será que o atual banco de dados vai suportar o nosso crescimento? Ou existe uma opção mais escalável?
</div>

## Cientista de dados


<div class = 'dado_full_width'>

- Que tal uma análise textual dos clientes que deixaram comentários sobre suas compras?
- Alguns clientes não escreveram um comentário. Mas por que eles estão satisfeitos?
- Com as informações da data de compra, você poderá prever vendas futuras!
- Você também poderá focar na logística e encontrar maneiras de otimizar os tempos de entrega.
- Esses dados possuem coordenadas de geolocalização. Há diferenças no padrão de consumo por regiões?
- Divirta-se descobrindo as categorias de produtos mais propensas à insatisfação do cliente.
- Crie recursos deste rico conjunto de dados, feature engineering ou anexe algumas informações públicas externas a ele.
- E um modelo para precificar os produtos do nosso catálogo? Modelagem matemática para otimizar rotas? Testes de hipóteses para validar algum questionamento?
</div>

## Analista de dados e Business Intelligence

<div class = 'dado_full_width'>
- Pense em alguns KPIs para monitoramento. Talvez outros para direcionamento dos gestores!
- Um cruzamento dos dados poderia gerar relatórios interessantes. Afinal, quem são os Top 10 em vendas? Que tipo produtos eles vendem? Qual é o impacto deles para o negócio?
- Que tal realizar uma análise exploratória dos dados. E então? Algo lhe chama a atenção?
- Você poderia apresentar esses dados em um dashboard. Isso daria agilidade na tomada de decisão!
- Temos interesse em suas habilidades com matemática aplicada e estatística descritiva. O que você pode nos mostrar com os dados?
</div>

## O que esperamos do candidato?

<div class = 'dado_full_width'>
- O que acha de escrever um **relatório** ou **slides** sobre a sua abordagem na solução de alguns desses problemas?
- Fique livre para **criar sua própria abordagem**, caso considere que as dicas anteriores não sejam pertinentes.
- **Fique a vontade para adotar softwares, processos e ferramentas que considerar adequados.**
- Pode ser em **qualquer formato**, queremos apenas entender como você **apresenta os resultados do seu trabalho.**
- Não esqueça de indicar em seu relatório os **links/endereços**, caso tenha hospedado códigos/arquivos em algum **repositório na internet**.
</div>

## Dados Aleatórios

- **86%** dos candidatos aprovados resolveram este desafio em **4 dias**
- **78%** dos **Engenheiros de Dados** aprovados fizeram algum tipo de implementação em **cloud**.
- **81%** dos candidatos aprovados apresentaram  um **relatório claro, objetivo e coeso.**
- **Tableu** foi a ferramenta preferida pelos **Analistas de Dados e BI** aprovados.
- **R**, **Julia** e **Python** foram as preferidas dos **Cientistas de Dados** aprovados.

## Descrição dos dados

<div class = 'dado_full_width'>
- olist_orders_dataset 
- olist_order_items_dataset 
- olist_order_reviews_dataset 
- olist_products_dataset 
- olist_order_payments_dataset 
- olist_customers_dataset 
- olist_geolocation_dataset 
- olist_sellers_dataset 
</div>


## {.fullpage .grad}

<div class="topic">
Análise exploratória
</div>


## Leitura dos dados

```{r leitura, echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out"}
orders <- read_csv("data/olist/olist_orders_dataset.csv") # spec(orders)
customers <- read_csv("data/olist/olist_customers_dataset.csv", col_types = cols(.default = "c"))
order_reviews <- read_csv("data/olist/olist_order_reviews_dataset_clean.csv", col_types = cols(.default = "c"))
order_payments <- read_csv("data/olist/olist_order_payments_dataset.csv")
order_items_details <- read_csv("data/olist/olist_order_items_dataset.csv")
sellers <- read_csv("data/olist/olist_sellers_dataset.csv", col_types = cols(.default = "c"))
geolocation <- read_csv("data/olist/olist_geolocation_dataset.csv")
products <- read_csv("data/olist/olist_products_dataset.csv")
```



## Regressão Linear

<div class = 'dado_full_width'>
> [...] sons do not tend toward their fathers' heights but instead “regress to” the mean of the population. 
---  **Sir Francis Galton (1885)**
</div>

```{r galton, echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
# install.packages("mosaicData")
base <- mosaicData::Galton %>% as_tibble() %>% mutate(midHeight = (father + mother)/2)
base %>%   ggplot() + theme_minimal() +
  geom_point(aes(x = midHeight, y = height), alpha = .25) +
  geom_function(fun = function(x) {y = x}, size = .75) +
  geom_function(fun = function(x) {y = mean(base$height)}, size = .75, linetype = "dotdash") +
  geom_smooth(aes(x = midHeight, y = height), method='lm', formula = y~x, se = FALSE, color = "red", linetype = "dashed") +
  xlab("Altura média dos pais (polegadas)") +
  ylab("Altura do filho (polegadas)")
```


<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source= "watch-out", out.width="75%"}
modelo_linear <- lm(height ~ mother + father + I(sex), data = base) 
summary(modelo_linear)
```
</div>

## Testando as hipóteses do modelo 2

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
erro  <- base %>% select(height, midHeight) %>% 
  mutate(resíduos = resid(modelo_linear),
         ajustado = fitted(modelo_linear))

erro %>% head(n = 20) %>% kbl() %>% kable_classic_2() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
  kable_styling(full_width = FALSE, font_size = 10) %>% 
  column_spec(3, color = if_else(erro$resíduos < 0, 'red', 'black'))
```
</div>

## Testando as hipóteses do modelo 2

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
erro %>% 
    ggplot(aes(x = resíduos, y = ..density..)) + geom_histogram(position = 'identity', color = 'white', bins = 30, fill = 'red', alpha = .2) +
    geom_density(position = 'identity', size = .75) + theme_bw()
```
</div>

## Testando as hipóteses do modelo 2

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
erro %>% pull(resíduos) %>% nortest::ad.test()
```
</div>

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
erro %>% ggplot() + geom_point(aes(x = ajustado, y = resíduos), alpha = .2) +
  labs(x = "Ajustado", y = "Resíduos") + theme_bw()
```
</div>


## Predito vs Valores verdadeiros

```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
erro %>% ggplot() + 
  geom_point(aes(x = ajustado, y = height), alpha = .2) +
  labs(x = "Ajustado", y = "Real") + theme_bw()
```

## Regressão Logística

<div class = 'dado_full_width'>
```{r echo=TRUE, fig.width=5, fig.height=5, message=FALSE, warning=FALSE, class.source="watch-out"}
salespeople <- read_csv("data/salespeople.csv")
salespeople_clean <- salespeople %>% 
  mutate(promoted = factor(promoted),
         performance = factor(performance, levels = 1:4, ordered = TRUE)) %>% na.omit 
ggpairs(salespeople_clean, ggplot2::aes(colour=promoted)) 
```
</div>

## Exemplo: Organizando os dados

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}

# Criar variáveis indicadoras
salespeople_ind  <- salespeople_clean %>% 
  dummy_cols(select_columns = "performance") %>%
  select(-performance)


salespeople_ind %>% head(n = 20) %>% kbl() %>% kable_classic_2() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
  kable_styling(full_width = FALSE, font_size = 10)
```
</div>

## Exemplo: Primeiro Modelo

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
modelo_completo <- 
  glm(formula = "promoted ~ .", family = "binomial", 
      data = salespeople_ind)

coeficientes <- tidy(modelo_completo) %>% 
  mutate(odds = exp(estimate),
         `2.5%` = exp(confint(modelo_completo))[,"2.5 %"],
         `97.5%` = exp(confint(modelo_completo))[,"97.5 %"])  
coeficientes %>% 
    mutate(across(where(is.numeric), ~ round(.x, 3))) %>% 
    kbl() %>% kable_classic_2() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
    kable_styling(full_width = FALSE, font_size = 10) %>% 
    column_spec(c(2:6), color = if_else(c(na.omit(coeficientes)$estimate < 0, TRUE), 'red', 'black'))
```
</div>

## Exemplo: Primeiro Modelo --- continuação

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
summary(modelo_completo)
```
</div>


## Exemplo: Segundo Modelo

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
modelo_simples <- 
  glm(formula = "promoted ~ sales + customer_rate", family = "binomial", 
      data = salespeople_ind)

coeficientes <- tidy(modelo_simples) %>% 
  mutate(odds = exp(estimate),
         `2.5%` = exp(confint(modelo_simples))[,"2.5 %"],
         `97.5%` = exp(confint(modelo_simples))[,"97.5 %"])  
coeficientes %>% 
    mutate(across(where(is.numeric), ~ round(.x, 3))) %>% 
    kbl() %>% kable_classic_2() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
    kable_styling(full_width = FALSE, font_size = 10) %>% 
    column_spec(c(2:6), color = if_else(c(na.omit(coeficientes)$estimate < 0, TRUE), 'red', 'black'))
```
</div>

## Exemplo: Segundo Modelo --- continuação

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
summary(modelo_simples)
```
</div>


## Qualidade do ajuste

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
pseudoR2 <- tibble(PseudoR2 = c("McFadden", "CoxSnell", "Nagelkerke", "Tjur"),
                  Valor = DescTools::PseudoR2(modelo_simples, which = PseudoR2))  

pseudoR2 %>% mutate(across(where(is.numeric), ~ round(.x, 2))) %>% 
  kbl() %>% kable_classic_2() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
    kable_styling(full_width = FALSE, font_size = 10) 

diagnostics <- LogisticDx::gof(modelo_simples, plotROC = FALSE)  
  
diagnostics$gof %>% as_tibble() %>% 
  kbl() %>% kable_classic_2() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
    kable_styling(full_width = FALSE, font_size = 10) %>% 
    column_spec(5, color = if_else(diagnostics$gof$pVal < .05, 'red', 'black'))
```
</div>

## Previsão de novos dados

<div class = 'dado_full_width'>
```{r echo=TRUE, message=FALSE, warning=FALSE, class.source="watch-out", out.width="75%"}
novos_dados <- tibble(sales = c(420, 510, 710), 
                        customer_rate = c(3.4, 2.3, 4.2))

previsão <- predict(modelo_simples, novos_dados, type = "response")

novos_dados %>% 
  mutate(Resposta = round(previsão, 2)) %>% 
  kbl() %>% kable_classic_2() %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>% 
    kable_styling(full_width = FALSE, font_size = 10)
```
</div>

## {.fullpage .grad}

<div class="topic">
Aplicação OLIST
</div>

<div class = 'dado_full_width'>
</div>


## Problema

> Como prever a satisfação do consumidor? Que variáveis influenciam mais?

**Dados**: https://github.com/olist/work-at-olist-data



